name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

env:
  MIRROR_URL: "git@github.com:EpitechPGE3-2025/G-CPP-500-NAN-5-2-rtype-2.git"
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_MAXSIZE: 500M
  CCACHE_COMPRESS: true
  CCACHE_COMPRESSLEVEL: 6

jobs:
  check_repository:
    name: check repository to start jobs
    runs-on: ubuntu-latest
    outputs:
      target: ${{ steps.new_output.outputs.value }}
    steps:
      - name: CHECKOUT
        uses: actions/checkout@v4

      - name: CHECK TARGET REPOSITORY
        id: new_output
        run: |
          temp=$(echo $MIRROR_URL | cut -d ':' -f 2 | sed "s/\.git//")
          if [ $temp = ${{ github.repository }} ]; then
            echo "::notice title=The target repository is also the current one::$temp"
            echo "value=1" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "value=0" >> "$GITHUB_OUTPUT"
          exit 0

  check_coding_style:
    name: check any coding style errors
    needs: [check_repository]
    if: ${{ needs.check_repository.outputs.target == 0 }}
    runs-on: ubuntu-latest
    steps:
      - name: CHECKOUT
        uses: actions/checkout@v4

      - name: SETUP PYTHON
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: CACHE CPPLINT
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-cpplint-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-cpplint-
            ${{ runner.os }}-pip-

      - name: INSTALL CPP LINTER
        run: |
          pip install cpplint
          chmod +x ./scripts/cpp_style_checker.sh

      - name: CHECK CODING STYLE
        run: |
          ./scripts/cpp_style_checker.sh

      - name: VERIFY CPP CODING STYLE
        run: |
          if [ -s coding-style-cpp-reports.log ]; then
            echo "CPP coding style errors found. See coding-style-cpp-reports.log for details."
            cat coding-style-cpp-reports.log
            exit 1
          else
            echo "No CPP coding style errors found."
          fi

  check_ubuntu_compilation:
    name: check project compilation on ubuntu
    needs: [check_repository]
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-build.outputs.cache-hit }}
    steps:
      - name: CHECKOUT
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: CACHE SYSTEM PACKAGES
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: cmake g++ make git build-essential ninja-build libx11-dev libxi-dev libxrandr-dev libxcursor-dev libudev-dev libgl1-mesa-dev ccache
          version: 1.1

      - name: SETUP VCPKG
        uses: ./.github/actions/setup-vcpkg

      - name: CACHE CCACHE
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ runner.os }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: CONFIGURE CCACHE
        run: |
          mkdir -p ${{ env.CCACHE_DIR }}
          ccache --set-config=cache_dir=${{ env.CCACHE_DIR }}
          ccache --set-config=max_size=${{ env.CCACHE_MAXSIZE }}
          ccache --set-config=compression=${{ env.CCACHE_COMPRESS }}
          ccache --set-config=compression_level=${{ env.CCACHE_COMPRESSLEVEL }}
          ccache --zero-stats
          ccache --show-stats

      - name: CACHE CMAKE BUILD
        id: cache-build
        uses: actions/cache@v4
        with:
          path: |
            build/unix/bin
            vcpkg
            vcpkg_installed
          key: ${{ runner.os }}-cmake-build-v2-${{ hashFiles('**/CMakeLists.txt', '**/vcpkg.json', '**/*.cpp', '**/*.hpp') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-cmake-build-v2-${{ hashFiles('**/CMakeLists.txt', '**/vcpkg.json') }}-
            ${{ runner.os }}-cmake-build-v2-

      - name: RUN COMPILATION
        run: |
          chmod +x ./scripts/compile_project.sh
          ./scripts/compile_project.sh

      - name: SHOW CCACHE STATS
        run: ccache --show-stats

  check_windows_compilation:
    name: check project compilation on windows
    needs: [check_repository]
    runs-on: windows-2022
    steps:
      - name: CHECKOUT
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: SETUP VCPKG
        uses: ./.github/actions/setup-vcpkg

      - name: CACHE CMAKE BUILD
        uses: actions/cache@v4
        with:
          path: |
            build/windows/bin
            vcpkg
            vcpkg_installed
          key: ${{ runner.os }}-cmake-build-${{ hashFiles('**/CMakeLists.txt', '**/vcpkg.json', '**/*.cpp', '**/*.hpp') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-cmake-build-${{ hashFiles('**/CMakeLists.txt', '**/vcpkg.json') }}-
            ${{ runner.os }}-cmake-build-

      - name: RUN COMPILATION
        env:
          CL: /MP
          UseMultiToolTask: true
          EnforceProcessCountAcrossBuilds: true
        run: |
          .\scripts\compile_project.bat
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Compilation failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }

  run_all_tests:
    name: run all tests
    needs: [check_repository]
    runs-on: ubuntu-latest
    steps:
      - name: CHECKOUT
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: CACHE SYSTEM PACKAGES
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: cmake g++ make git build-essential ninja-build libx11-dev libxi-dev libxrandr-dev libxcursor-dev libudev-dev libgl1-mesa-dev ccache
          version: 1.1

      - name: SETUP VCPKG
        uses: ./.github/actions/setup-vcpkg

      - name: CACHE CCACHE
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ runner.os }}-ccache-tests-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-tests-
            ${{ runner.os }}-ccache-

      - name: CONFIGURE CCACHE
        run: |
          mkdir -p ${{ env.CCACHE_DIR }}
          ccache --set-config=cache_dir=${{ env.CCACHE_DIR }}
          ccache --set-config=max_size=${{ env.CCACHE_MAXSIZE }}
          ccache --set-config=compression=${{ env.CCACHE_COMPRESS }}
          ccache --set-config=compression_level=${{ env.CCACHE_COMPRESSLEVEL }}
          ccache --zero-stats
          ccache --show-stats

      - name: CACHE CMAKE BUILD FOR TESTS
        uses: actions/cache@v4
        with:
          path: |
            build/unix/bin
            vcpkg_installed
          key: ${{ runner.os }}-cmake-tests-${{ hashFiles('**/CMakeLists.txt', '**/vcpkg.json', '**/tests/**/*.cpp', '**/tests/**/*.hpp') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-cmake-tests-${{ hashFiles('**/CMakeLists.txt', '**/vcpkg.json') }}-
            ${{ runner.os }}-cmake-tests-

      - name: RUN UNIT TESTS
        run: |
          chmod +x ./scripts/run_unit_tests.sh
          ./scripts/run_unit_tests.sh

      - name: SHOW CCACHE STATS
        run: ccache --show-stats

  push_to_mirror:
    name: push to target repository
    needs: [run_all_tests, check_windows_compilation, check_ubuntu_compilation, check_coding_style]
    if: ${{ github.event_name == 'push' }}
    environment: RTYPE
    runs-on: ubuntu-latest
    steps:
      - name: CHECKOUT
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: REPOSITORY MIRRORING
        uses: pixta-dev/repository-mirroring-action@v1
        with:
          target_repo_url: ${{ env.MIRROR_URL }}
          ssh_private_key: ${{ secrets.GIT_SSH_PRIVATE_KEY }}

  calculate_version:
    name: calculate semantic version
    needs: [run_all_tests, check_windows_compilation, check_ubuntu_compilation, check_coding_style]
    if: ${{ github.event_name == 'push' }}
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.semver.outputs.version }}
      version_type: ${{ steps.semver.outputs.version_type }}
    steps:
      - name: CHECKOUT
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: GET VERSION TYPE FROM PR LABELS
        id: get_version_type
        run: |
          # Get labels from the latest merged PR
          PR_NUMBER=$(gh pr list --state merged --limit 10 --json mergedAt,number --jq 'sort_by(.mergedAt) | reverse | .[0].number')
          if [ -n "$PR_NUMBER" ]; then
            LABELS=$(gh pr view $PR_NUMBER --json labels --jq '.labels[].name')
            echo "Labels found: $LABELS"
            
            if echo "$LABELS" | grep -q "release:major"; then
              echo "type=major" >> "$GITHUB_OUTPUT"
            elif echo "$LABELS" | grep -q "release:minor"; then
              echo "type=minor" >> "$GITHUB_OUTPUT"
            elif echo "$LABELS" | grep -q "release:patch"; then
              echo "type=patch" >> "$GITHUB_OUTPUT"
            else
              echo "type=none" >> "$GITHUB_OUTPUT"
              echo "::notice::No release label found, will keep current version"
            fi
          else
            echo "type=none" >> "$GITHUB_OUTPUT"
            echo "::notice::No merged PR found, will keep current version"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: CALCULATE SEMANTIC VERSION
        id: semver
        run: |
          # Get the latest semantic version tag (v*.*.*)
          LATEST_TAG=$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n 1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0"
          fi
          echo "Latest semantic version tag: $LATEST_TAG"
          VERSION=${LATEST_TAG#v}
          
          # Separate major.minor.patch
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # Increment according to the type
          VERSION_TYPE="${{ steps.get_version_type.outputs.type }}"

          if [ "$VERSION_TYPE" = "none" ]; then
            # No label, keep the current version
            NEW_VERSION="$LATEST_TAG"
            echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
            echo "version_type=no-change" >> "$GITHUB_OUTPUT"
            echo "::notice::No release label, keeping current version $NEW_VERSION"
          else
            # Increment the version
            case "$VERSION_TYPE" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              patch)
                PATCH=$((PATCH + 1))
                ;;
            esac
            
            NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
            echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
            echo "version_type=$VERSION_TYPE" >> "$GITHUB_OUTPUT"
            echo "::notice::New version will be $NEW_VERSION (type: $VERSION_TYPE)"
          fi

  build_unix_package:
    name: build unix package
    needs: [calculate_version]
    if: ${{ github.event_name == 'push' }}
    runs-on: ubuntu-latest
    steps:
      - name: CHECKOUT
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: CREATE UNIX SOURCE ARCHIVE
        run: |
          mkdir -p release-package
          cp -r client server common configs assets libs scripts tests CMakeLists.txt CMakePresets.json vcpkg.json libraries release-package/
          cd release-package
          tar -czf ../r-type-unix-${{ needs.calculate_version.outputs.version }}.tar.gz .
          cd ..

      - name: UPLOAD UNIX ARTIFACT
        uses: actions/upload-artifact@v4
        with:
          name: unix-package
          path: r-type-unix-${{ needs.calculate_version.outputs.version }}.tar.gz
          retention-days: 1

  build_windows_server_package:
    name: build windows server package
    needs: [calculate_version]
    if: ${{ github.event_name == 'push' }}
    runs-on: windows-2022
    steps:
      - name: CHECKOUT
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SETUP VCPKG
        uses: ./.github/actions/setup-vcpkg

      - name: CACHE CMAKE BUILD
        uses: actions/cache@v4
        with:
          path: |
            build/windows/bin
            vcpkg
            vcpkg_installed
          key: ${{ runner.os }}-cmake-build-${{ hashFiles('**/CMakeLists.txt', '**/vcpkg.json', '**/*.cpp', '**/*.hpp') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-cmake-build-${{ hashFiles('**/CMakeLists.txt', '**/vcpkg.json') }}-
            ${{ runner.os }}-cmake-build-

      - name: BUILD PROJECT
        env:
          CL: /MP
          UseMultiToolTask: true
          EnforceProcessCountAcrossBuilds: true
        run: |
          .\scripts\compile_project.bat server

      - name: CREATE WINDOWS SERVER BINARIES ARCHIVE
        run: |
          New-Item -ItemType Directory -Force -Path "r-type-server-windows"
          New-Item -ItemType Directory -Force -Path "r-type-server-windows\libraries"
          New-Item -ItemType Directory -Force -Path "r-type-server-windows\configs"
          Copy-Item -Path "r-type_server.exe" -Destination "r-type-server-windows\" -ErrorAction SilentlyContinue
          Copy-Item -Path "build\windows\bin\server\Release\*.dll" -Destination "r-type-server-windows\" -ErrorAction SilentlyContinue
          Copy-Item -Path "build\windows\bin\vcpkg_installed\x64-windows\bin\*.dll" -Destination "r-type-server-windows\" -ErrorAction SilentlyContinue
          Copy-Item -Path "libraries\*.dll" -Destination "r-type-server-windows\libraries\" -ErrorAction SilentlyContinue
          Copy-Item -Path "configs\*" -Destination "r-type-server-windows\configs\" -Recurse -ErrorAction SilentlyContinue
          Compress-Archive -Path "r-type-server-windows" -DestinationPath "r-type-server-windows-${{ needs.calculate_version.outputs.version }}.zip"

      - name: UPLOAD WINDOWS SERVER ARTIFACT
        uses: actions/upload-artifact@v4
        with:
          name: windows-server-package
          path: r-type-server-windows-${{ needs.calculate_version.outputs.version }}.zip
          retention-days: 1

  build_windows_client_package:
    name: build windows client package
    needs: [calculate_version]
    if: ${{ github.event_name == 'push' }}
    runs-on: windows-2022
    steps:
      - name: CHECKOUT
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SETUP VCPKG
        uses: ./.github/actions/setup-vcpkg

      - name: CACHE CMAKE BUILD
        uses: actions/cache@v4
        with:
          path: |
            build/windows/bin
            vcpkg
            vcpkg_installed
          key: ${{ runner.os }}-cmake-build-${{ hashFiles('**/CMakeLists.txt', '**/vcpkg.json', '**/*.cpp', '**/*.hpp') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-cmake-build-${{ hashFiles('**/CMakeLists.txt', '**/vcpkg.json') }}-
            ${{ runner.os }}-cmake-build-

      - name: BUILD PROJECT
        env:
          CL: /MP
          UseMultiToolTask: true
          EnforceProcessCountAcrossBuilds: true
        run: |
          .\scripts\compile_project.bat client

      - name: CREATE WINDOWS CLIENT BINARIES ARCHIVE
        run: |
          New-Item -ItemType Directory -Force -Path "r-type-client-windows"
          New-Item -ItemType Directory -Force -Path "r-type-client-windows\libraries"
          New-Item -ItemType Directory -Force -Path "r-type-client-windows\configs"
          Copy-Item -Path "r-type_client.exe" -Destination "r-type-client-windows\" -ErrorAction SilentlyContinue
          Copy-Item -Path "build\windows\bin\client\Release\*.dll" -Destination "r-type-client-windows\" -ErrorAction SilentlyContinue
          Copy-Item -Path "build\windows\bin\vcpkg_installed\x64-windows\bin\*.dll" -Destination "r-type-client-windows\" -ErrorAction SilentlyContinue
          Copy-Item -Path "libraries\*.dll" -Destination "r-type-client-windows\libraries\" -ErrorAction SilentlyContinue
          Copy-Item -Path "configs\*" -Destination "r-type-client-windows\configs\" -Recurse -ErrorAction SilentlyContinue
          Compress-Archive -Path "r-type-client-windows" -DestinationPath "r-type-client-windows-${{ needs.calculate_version.outputs.version }}.zip"

      - name: UPLOAD WINDOWS CLIENT ARTIFACT
        uses: actions/upload-artifact@v4
        with:
          name: windows-client-package
          path: r-type-client-windows-${{ needs.calculate_version.outputs.version }}.zip
          retention-days: 1

  create_release:
    name: create unified release
    needs: [calculate_version, build_unix_package, build_windows_server_package, build_windows_client_package]
    if: ${{ github.event_name == 'push' }}
    environment: RTYPE
    runs-on: ubuntu-latest
    steps:
      - name: CHECKOUT
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: DOWNLOAD UNIX ARTIFACT
        uses: actions/download-artifact@v4
        with:
          name: unix-package
          path: ./artifacts

      - name: DOWNLOAD WINDOWS CLIENT ARTIFACT
        uses: actions/download-artifact@v4
        with:
          name: windows-client-package
          path: ./artifacts

      - name: DOWNLOAD WINDOWS SERVER ARTIFACT
        uses: actions/download-artifact@v4
        with:
          name: windows-server-package
          path: ./artifacts

      - name: CREATE UNIFIED RELEASE
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.calculate_version.outputs.version }}
          allowUpdates: true
          name: Release ${{ needs.calculate_version.outputs.version }}
          body: |
            Automated release ${{ needs.calculate_version.outputs.version }}
            
            **Version Type:** `${{ needs.calculate_version.outputs.version_type }}`

            ## ðŸ“¦ Windows Installation
            1. Download `r-type-client-windows-${{ needs.calculate_version.outputs.version }}.zip` and `r-type-server-windows-${{ needs.calculate_version.outputs.version }}.zip`
            2. Unzip the archives
            3. Run `r-type_client.exe` or `r-type_server.exe`

            ## ðŸ“¦ Unix Installation
            1. Download `r-type-unix-${{ needs.calculate_version.outputs.version }}.tar.gz`
            2. Extract: `tar -xzf r-type-unix-${{ needs.calculate_version.outputs.version }}.tar.gz`

            if you do not have vcpkg setup already:
            - Install dependencies: `chmod +x scripts/install_dependencies.sh && ./scripts/install_dependencies.sh`

            3. Compile: `chmod +x scripts/compile_project.sh && ./scripts/compile_project.sh`
          draft: false
          prerelease: false
          artifacts: "artifacts/*"
          artifactContentType: application/octet-stream
